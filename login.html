<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <div id="content">
    <h1>Depop Bot</h1>

    <div id="LoggedOutView">
      <table id="LoginTable">
        <tr>
          <th><label id=UserNameLabel>Enter username: </label></th>
          <th><input id="UserName"></th>
          <th><label id=PassWordLabel>Enter password: </label></th>
          <th><input id="PassWord"></th>
          <th><button id="LoginButton" style="display: table; margin: 0 auto;">Log in</button></th>
        </tr>
      </table>
    </div>
  </div>
  </body>
  <script> 
    function setBearer() {
      (async function () {
        let bearer = await getCookie();

        //save in local storage
        chrome.storage.sync.set({ bearer }, function () {
        });
      })();
    }   

    async function getCookie() { //get depop bearer from logged in user
    const cookies = await chrome.cookies.getAll({ "name": "access_token" });
    return cookies[0].value;
}
      const cookies = await chrome.cookies.getAll({ "name": "access_token" });
      return cookies[0].value;
  </script>


  <script>
    let loginButton = document.getElementById("LoginButton");

loginButton.addEventListener("click", async () => {
  //if above successfuly set logged in to true 
  let isLoggedIn = true;
  chrome.storage.sync.set({ isLoggedIn }, function () {
    console.log('isLoggedIn is set to ' + isLoggedIn);
  });

  //get bearer token / username 
  setBearer();

  login(document.getElementById("UserName").value);
});

function login(userNameInput) {
  let username = userNameInput;
  console.log(username);

  chrome.storage.sync.set({ username }, function () {
    console.log('username is set to ' + username);
  });

  const requestOptions = {
    method: 'GET',
    redirect: 'follow'
  };

  var responseClone; 
  fetch("https://depop.com/" + userNameInput, requestOptions)
    .then(function (response) {
      responseClone = response.clone();
      return response.json();
    })
    .then(function (result) {
      userId = result.id;
      
      chrome.storage.sync.set({ userId }, function () {
        console.log('userId is set to ' + userId);

        chrome.action.setPopup({ popup: "popup.html" });
        window.location.href = "popup.html";
      })
    }, function (rejectionReason) {
        console.log('Error parsing JSON from response:', rejectionReason, responseClone); // 4
        responseClone.text() // 5
        .then(function (bodyText) {
          console.log('Received the following instead of valid JSON:', bodyText); // 6
        });
    });
}  
  </script>
</html>